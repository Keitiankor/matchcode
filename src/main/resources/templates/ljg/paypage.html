<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Title</title>
        </head>
        <body>
            <table>
                <label for="calendar">날짜:</label>
                <input id="calendar" name="calendar" type="datetime-local">
                <p> 장소: <span th:text="${mapId}"></span></p>
            </table>
            <table>
                <tr><b>포인트</b></tr>
                <p>보유 포인트: <span id="totalPointsValue" th:text="${totalPoints}"></span></p>
            </table>
            <table>
                <tr><b>결제</b></tr>
                <tr>
                    <p>가격 :<span id="pricePoints" th:text="${price}"></span></p>
                    <td>결제 포인트 :<span id="payPointsValue"></span>
                        <button onclick="location.href='test3'" type="button">추가충전</button>
                    </td>
                </tr>
            </table>
            <button onclick="handlePayment()" type="button">결제</button>

            <script>
                window.onload = function() {
                    var totalPointsValue = parseInt(document.getElementById("totalPointsValue").textContent);
                    var pricePoints = parseInt(document.getElementById("pricePoints").textContent);
                    var payPointsValueElement = document.getElementById("payPointsValue");

                    if (totalPointsValue < pricePoints) {
                        payPointsValueElement.textContent = totalPointsValue;
                        payPointsValueElement.style.color = "red";
                    } else {
                        payPointsValueElement.textContent = pricePoints;
                    }
                };

                function handlePayment() {
                    var totalPointsValue = parseInt(document.getElementById("totalPointsValue").textContent);
                    var pricePoints = parseInt(document.getElementById("pricePoints").textContent);
                    var payPointsValueElement = document.getElementById("payPointsValue");
                    //alert("1")
                    if (totalPointsValue < pricePoints) {
                        payPointsValueElement.textContent = totalPointsValue;
                        alert("보유 포인트가 부족합니다.");
                    } else {
                        payPointsValueElement.textContent = pricePoints;
                        performPayment(pricePoints);
                    }
                }

                function performPayment(pricePoints) {
                    alert(pricePoints + "결제를 진행합니다.");
                    var memberId = 1; // 실제 사용자 ID로 대체
                    //var pointToCharge = parseInt(document.getElementById("pricePoints").textContent);
                    // 결제 처리를 위해 컨트롤러로 AJAX 요청 전송
                    $.ajax({
                        url: "/payPoint",
                        type: "GET",
                        data: {
                            memberId: memberId,
                            price: pricePoints,
                            matchDate: matchDate,
                            mapId: mapId
                        },
                        success: function(response) {
                            if (response === "success") {
                                var totalPointsValueElement = document.getElementById("totalPointsValue");
                                var totalPointsValue = parseInt(totalPointsValueElement.textContent);
                                totalPointsValueElement.textContent = totalPointsValue - pointToCharge;

                                alert("Payment successful.");
                                // UI를 업데이트하거나 필요한 다른 작업 수행
                            } else {
                                alert("An error occurred while processing the payment.");
                            }
                        },
                        error: function() {
                            alert("An error occurred while communicating with the server.");
                        }
                    });
                }
            </script>
        </body>
    </html>
